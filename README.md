# cowcat-rs

Rust implementation of the CowCat proof-of-work shield. It wraps any upstream service with a PoW gate, a reverse proxy, and a rules engine while preserving the existing task/verify protocol (obfuscated frames, `cowcat.waf.token`, and the JavaScript/WASM front-end) so existing clients remain compatible.

## Architecture overview
- **HTTP surface** (`src/main.rs`) – Axum serves `/favicon.ico` and every `/__cowcatwaf/*` endpoint directly, applies the `pow_gate` middleware to other routes, and forwards verified traffic to a configurable upstream via `proxy_handler`.
- **PoW gate** (`middleware/pow.rs`) – handles service-worker bypasses, optional rules, gzip-compressed challenge responses, cookie verification (UA + optional IP hash), and a `PowVerified` marker used by the proxy layer.
- **PoW handlers** (`handlers/pow.rs`) – expose the HTML challenge page, `/task` & `/verify` binary endpoints, `/ok` health probe, and static asset serving under `/assets/*`. Generated tasks live in-memory for 120 seconds and are single-use.
- **Rules engine** (`rules.rs`) – matches requests by path, headers, and CIDRs to `allow`, `block`, or `challenge` (with a `difficulty_delta`). The first match wins; if none match, `default_action` applies.
- **Reverse proxy** (`proxy/forward.rs`) – rewrites URIs/headers, forwards via `hyper`, adds `X-Forwarded-*`, and can route `PowVerified` requests to host-specific upstream targets.
- **State & secrets** (`state.rs`) – holds the config, rules engine, task store, template assets, proxy client, and a per-instance server secret derived from `pow.salt` (or randomly generated if blank).
- **Static assets & wasm** – source files live in `static/` (`catpaw.*`, styles, imagery) and `static/assets/` stores the built/minified JS, worker, and wasm blobs embedded at compile time via `rust-embed`. The wasm worker lives under `wasm/` and is copied to `static/assets/catpaw.wasm` during the build.

## Getting started
1. Copy `config.toml.example` to `config.toml` and tune the upstream target, PoW difficulty, salt, and rules section to match your deployment.
2. Rebuild the web/wasm assets whenever the client-side sources change:
   - Run `./wasm/build.sh` to compile `wasm/src/lib.rs` with `wasm32-unknown-unknown` and push `cowcat_pow_wasm.wasm` into `static/assets/`.
   - Run `make jsminify` (requires `bunx esbuild`) to minify `static/catpaw.js` and `static/catpaw.worker.js` into `static/assets/`.
   - **Do not edit the generated files** under `static/assets/`; they are regenerated by the scripts.
3. Start the service with your config: `cargo run -- --config config.toml`, or build a release binary with `cargo build --release` / `make build`.

## Usage
- `cargo run -- --config config.toml` runs the proxy locally; point clients at `localhost:8080`.
- Use `cargo build --release` / `./target/release/cowcat-rs --config config.toml` when shipping binaries into production.
- The service honors the environment overrides listed below, letting you tweak behavior (difficulty, upstream, etc.) without editing `config.toml`.
- Pull the CI/CD-built Docker image with `docker pull ghcr.io/hynor/cowcat-rs:latest` and run it via `docker run --rm -p 8080:8080 -v "$(pwd)/config.toml:/app/config.toml" ghcr.io/hynor/cowcat-rs:latest`.
- Mount your updated `static/assets/` directory into the container if you regenerate assets so the embedded challenge page uses the right scripts.

## Configuration summary
- `[server]`
  - `listen`: address the service binds to (default `0.0.0.0:8080`).
- `[pow]`
  - `difficulty`: 0 disables the gate; 1..=10 map to `difficulty × 4` bits for task creation.
  - `cookie_expire_hours`: lifetime of `cowcat.waf.token`.
  - `salt`: seeds the HMAC key for signed cookies; leave blank to auto-generate a 32-character secret (logged at startup).
  - `workers` / `worker_type`: echoed to the client in `/task`.
  - `ip_policy`: `none`, `enable`, or `strict`; controls whether the IP hash is captured and enforced inside cookies.
  - `test_mode`: always issue a challenge even if a valid cookie exists.
- `[proxy]`
  - `target`: default upstream URI.
  - `host_rule`: optional host-specific targets (used only after `PowVerified`).
- `[rules]`
  - `enabled`: toggle rule matching.
  - `default_action`: fallback action (`allow`, `block`, `challenge`).
  - Each `[[rules.rule]]` can match on `path_prefix`, `path_exact`, `header`, and/or `ip_cidr`, and set an optional `difficulty_delta`. The first match wins.

## Environment variables
- `COWCAT_SERVER_LISTEN` overrides `[server].listen` (e.g., `0.0.0.0:8080`).
- `COWCAT_POW_DIFFICULTY` overrides `[pow].difficulty`; set to `0` to disable the gate or `1..=10` for increasing PoW bits.
- `COWCAT_POW_COOKIE_EXPIRE_HOURS` controls how long `cowcat.waf.token` is valid without modifying the TOML.
- `COWCAT_POW_SALT` supplies the HMAC key for signed cookies; keep it secret or leave it blank to generate a 32-character random secret at startup (logged once at DEBUG).
- `COWCAT_POW_WORKERS` and `CATPOW_WORKER_TYPE` override the worker metadata returned by `/task`.
- `COWCAT_POW_IP_POLICY` is `none`, `enable`, or `strict`; enabling it hashes the extracted client IP, binds cookies to that hash, and lets CIDR-based rules fire via `rules.rule.ip_cidr`.
- `COWCAT_POW_TEST_MODE` (`true`/`false`) forces the gate to issue a challenge for every request, which is useful for integration testing.
- `COWCAT_PROXY_TARGET` rewrites `[proxy].target` at runtime so you can pivot upstreams in environments like Kubernetes without editing `config.toml`.

## Proof-of-work workflow
1. Requests to `/__cowcatwaf/*`, `/favicon.ico`, or service-worker scripts bypass the gate; difficulty 0 short-circuits the middleware entirely.
2. If a valid `cowcat.waf.token` cookie exists (UA + optional IP hash match plus HMAC), the request proceeds and `PowVerified` is inserted so the proxy can route per-host.
3. If the rules engine matches, it immediately `allow`s, `block`s (403), or `challenge`s. Challenges adjust difficulty via `difficulty_delta`, clamped to `0..=10`.
4. When no matching rule exists, the default action renders the HTML challenge page using `static/catpaw.html`, embedded assets, and a newly generated task (seed, bits, scope, UA hash, IP hash). Tasks expire after 120 seconds and are single-use.
5. Clients submit XOR-obfuscated frames to `/__cowcatwaf/task` and `/__cowcatwaf/verify`; valid proofs result in signed cookies that gate future requests.

## Assets & wasm
- Source front-end assets: `static/catpaw.html`, `static/catpaw.js`, `static/catpaw.worker.js`, `static/catpaw.css`, and `static/cowcat.webp`.
- Generated/minified bundles live in `static/assets/` and are embedded at compile time (`rust-embed`). Regenerate them only with `make jsminify` and `./wasm/build.sh`.
- Wasm worker path: `wasm/src/lib.rs` → `cargo build --target wasm32-unknown-unknown --release` → copy output to `static/assets/catpaw.wasm` via `./wasm/build.sh`.

## Development & build commands
- `cargo build --release` or `make build` – compile the server in release mode.
- `make build-mac` / `make build-linux` – produce target-specific binaries.
- `make jsminify` – minify the client-side JS (requires `bunx esbuild`).
- `./wasm/build.sh` – compile the wasm worker and copy it to `static/assets/catpaw.wasm`.
- `cargo run -- --config config.toml` – run the server locally with a given config.
- `cargo fmt` / `cargo clippy` – keep the Rust codebase tidy.
- `cargo test` – no automated tests exist yet; add `#[cfg(test)]` or integration tests if you add behavior and run the command yourself.

## Logging & secrets
- Tracing emits JSON to stdout (default level `INFO`), configurable via `RUST_LOG`.
- `pow.salt` drives the cookie HMAC secret; leave it empty to auto-generate a 32-character value that is logged once at DEBUG level.

## Deployment notes
- `docker build -t cowcat-rs .` and `docker-compose up` work out of the box using the included `Dockerfile` / `docker-compose.yml`.
- The repository's CI/CD pipeline publishes `ghcr.io/hynor/cowcat-rs:latest`; pull that image in production to get the latest build artifacts without compiling locally.
- Always ship the generated files in `static/assets/` and `static/assets/catpaw.wasm` alongside the binary so the challenge experience works.

## License
MIT © 2026 KOMATA
