(function(){"use strict";const c={progress:0,status:"\u51C6\u5907\u9A8C\u8BC1\u6311\u6218...",progressText:"\u521D\u59CB\u5316",error:!1,errorMessage:"",errorDetails:null,showErrorDetails:!1,hashRate:0,totalHashes:0,manualRedirect:!1,pendingRedirectUrl:null},o={};function F(){o.statusContainer=document.getElementById("status-container"),o.errorContainer=document.getElementById("error-container"),o.errorMessage=document.getElementById("error-message"),o.errorDetails=document.getElementById("error-details"),o.errorDetailsToggle=document.getElementById("error-details-toggle"),o.errorDetailsContent=document.getElementById("error-details-content"),o.errorDetailsList=document.getElementById("error-details-list"),o.progressPercent=document.getElementById("progress-percent"),o.progressBar=document.getElementById("progress-bar"),o.progressText=document.getElementById("progress-text"),o.hashRateValue=document.getElementById("hash-rate-value"),o.totalHashesValue=document.getElementById("total-hashes-value"),o.hashStatsContainer=document.getElementById("hash-stats"),o.visualImage1=document.getElementById("visual-image-1"),o.visualImage2=document.getElementById("visual-image-2"),o.manualRedirectContainer=document.getElementById("manual-redirect-container"),o.manualRedirectBtn=document.getElementById("manual-redirect-btn")}function m(e,t){const r=Math.min(100,Math.max(0,e));c.progress!==r&&(c.progress=r,o.progressBar&&(o.progressBar.style.width=r+"%"),o.progressPercent&&(o.progressPercent.textContent=Math.round(r)+"%")),t!==void 0&&c.progressText!==t&&(c.progressText=t,o.progressText&&(o.progressText.textContent=t))}function I(e){c.status!==e&&(c.status=e,o.statusContainer&&(o.statusContainer.textContent=e))}function D(e,t=null){c.error=!0,c.errorMessage=e,c.errorDetails=t,c.status="",o.statusContainer&&(o.statusContainer.style.display="none"),o.errorContainer&&(o.errorContainer.style.display="block"),o.errorMessage&&(o.errorMessage.textContent=e),t&&t.length>0&&(N(t),o.errorDetails&&(o.errorDetails.style.display="block"))}function B(e,t){c.hashRate=e,o.hashRateValue&&(o.hashRateValue.textContent=q(e)),o.totalHashesValue&&(o.totalHashesValue.textContent=O(t)),o.hashStatsContainer&&(o.hashStatsContainer.style.display=e>0?"grid":"none")}function P(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}function N(e){if(!o.errorDetailsList)return;const t=document.getElementById("error-detail-template");if(!t){console.error("Error detail template not found");return}o.errorDetailsList.innerHTML="",e.forEach((r,n)=>{const l=t.content.cloneNode(!0),s=l.querySelector(".error-detail-item"),a=s.querySelector(".error-detail-label");if(a){let i="\u9519\u8BEF #"+(n+1);r.workerId!==void 0&&(i+=" (Worker "+r.workerId+")"),a.textContent=i}const d=(i,u,g)=>{const p=s.querySelector(i);p&&g!==void 0&&g!==""?(p.innerHTML="<strong>"+u+":</strong> "+P(String(g)),p.style.display="block"):p&&(p.style.display="none")};if(d('[data-field="phase"]',"\u9636\u6BB5",r.phase),d('[data-field="error"]',"\u9519\u8BEF",r.error),d('[data-field="errorType"]',"\u7C7B\u578B",r.errorType),d('[data-field="filename"]',"\u6587\u4EF6",r.filename?r.filename+":"+r.lineno+":"+r.colno:void 0),d('[data-field="errorStack"]',"\u5806\u6808",r.errorStack),r.workerInfo){const i=s.querySelector('[data-field="workerInfo"]');if(i){const u=r.workerInfo;i.innerHTML="<strong>Worker \u73AF\u5883:</strong><br>- TextEncoder: "+(u.hasTextEncoder?"\u2713":"\u2717")+"<br>- WebAssembly: "+(u.hasWebAssembly?"\u2713":"\u2717")+"<br>- instantiateStreaming: "+(u.hasWebAssemblyInstantiateStreaming?"\u2713":"\u2717")+"<br>- UserAgent: "+P(u.userAgent),i.style.display="block"}}if(r.browserInfo){const i=s.querySelector('[data-field="browserInfo"]');if(i){const u=r.browserInfo;i.innerHTML="<strong>\u6D4F\u89C8\u5668\u73AF\u5883:</strong><br>- Worker: "+(u.hasWorker?"\u2713":"\u2717")+"<br>- WebAssembly: "+(u.hasWebAssembly?"\u2713":"\u2717")+"<br>- TextEncoder: "+(u.hasTextEncoder?"\u2713":"\u2717")+"<br>- UserAgent: "+P(u.userAgent),i.style.display="block"}}o.errorDetailsList.appendChild(l)})}function V(){o.errorDetailsToggle&&o.errorDetailsToggle.addEventListener("click",function(){c.showErrorDetails=!c.showErrorDetails,o.errorDetailsToggle.textContent=c.showErrorDetails?"\u9690\u85CF\u9519\u8BEF\u8BE6\u60C5":"\u663E\u793A\u9519\u8BEF\u8BE6\u60C5",o.errorDetailsContent&&(o.errorDetailsContent.style.display=c.showErrorDetails?"block":"none")}),o.visualImage1&&o.visualImage1.addEventListener("click",function(){c.manualRedirect=!0,console.log("Manual redirect mode enabled")}),o.visualImage2&&o.visualImage2.addEventListener("click",function(){c.manualRedirect=!0,console.log("Manual redirect mode enabled")}),o.manualRedirectBtn&&o.manualRedirectBtn.addEventListener("click",function(){c.pendingRedirectUrl&&(window.location.href=c.pendingRedirectUrl)})}function q(e){return e>=1e6?(e/1e6).toFixed(2)+" MH/s":e>=1e3?(e/1e3).toFixed(2)+" KH/s":e+" H/s"}function O(e){return e>=1e9?(e/1e9).toFixed(2)+" B":e>=1e6?(e/1e6).toFixed(2)+" M":e>=1e3?(e/1e3).toFixed(2)+" K":e.toString()}const T=(async()=>{const t=await(await fetch("/__cowcatwaf/assets/catpaw.wasm")).arrayBuffer(),{instance:r}=await WebAssembly.instantiate(t,{});return r.exports})();function J(e,t){return new DataView(e.memory.buffer).getUint32(t,!0)}function K(e,t,r){return new Uint8Array(e.memory.buffer,t,r).slice()}function _(e,t){const r=new TextEncoder().encode(t||"");if(r.length===0)return{ptr:0,len:0};const n=e.alloc(r.length);return n?(new Uint8Array(e.memory.buffer,n,r.length).set(r),{ptr:n,len:r.length}):{ptr:0,len:0}}function C(e,t,r){const n=e.alloc(4);if(!n)throw new Error("Failed to allocate memory for output length");new DataView(e.memory.buffer).setUint32(n,0,!0);const l=t(...r,n),s=J(e,n);let a=new Uint8Array;return l&&s>0&&(a=K(e,l,s),e.dealloc(l,s)),e.dealloc(n,4),a}async function se(e){const t=await T,{ptr:r,len:n}=_(t,e),l=C(t,t.encode_task_request,[r,n]);return r&&n>0&&t.dealloc(r,n),l}async function z(e,t,r){const n=await T,l=_(n,e),s=_(n,t),a=_(n,r),d=C(n,n.encode_verify_request,[l.ptr,l.len,s.ptr,s.len,a.ptr,a.len]);return l.ptr&&l.len>0&&n.dealloc(l.ptr,l.len),s.ptr&&s.len>0&&n.dealloc(s.ptr,s.len),a.ptr&&a.len>0&&n.dealloc(a.ptr,a.len),d}async function j(e){const t=await T;if(!e||e.length===0)throw new Error("Empty frame bytes");const r=t.alloc(e.length);if(!r)throw new Error("Failed to allocate memory for frame");new Uint8Array(t.memory.buffer,r,e.length).set(e);const n=C(t,t.decode_task_response,[r,e.length]);return t.dealloc(r,e.length),JSON.parse(new TextDecoder().decode(n))}async function G(e){const t=await T;if(!e||e.length===0)throw new Error("Empty frame bytes");const r=t.alloc(e.length);if(!r)throw new Error("Failed to allocate memory for frame");new Uint8Array(t.memory.buffer,r,e.length).set(e);const n=C(t,t.decode_verify_response,[r,e.length]);return t.dealloc(r,e.length),JSON.parse(new TextDecoder().decode(n))}function Q(e=3,t=1){const r=Math.floor(navigator.hardwareConcurrency||1);return Math.min(e,Math.max(1,r-t))}function X(e){return"v1|"+e.seed+"|"+e.exp+"|"+e.bits+"|"+e.scope+"|"+e.ua_hash+"|"}function H(e){return String(e||"").trim().toLowerCase()==="native"?"native":"wasm"}function Y(e){if(!e||e.length<8)return"";const t=new TextEncoder().encode("cowcatwaflibwafcatcow"),n=new Uint8Array(e).slice();for(let a=0;a<n.length;a++)n[a]^=t[a%t.length];if(n[0]!==67||n[1]!==87||n[2]!==1||n[3]!==2||(n[4]<<24|n[5]<<16|n[6]<<8|n[7])>>>0!==n.length-8)return"";const s=n.subarray(8);for(let a=0;a+3<=s.length;){const d=s[a],i=s[a+1]<<8|s[a+2];if(a+=3,a+i>s.length)return"";if(d===11)return new TextDecoder().decode(s.subarray(a,a+i));a+=i}return""}function Z(e,t){const r=Math.max(0,Math.trunc(Number(e)||0)),n=Number(t);if(!Number.isFinite(n)||n<=0)return 0;const l=Math.pow(16,-n),s=Math.pow(1-l,r),a=(1-Math.pow(s,2))*100;return Number.isFinite(a)?Math.max(0,Math.min(100,a)):0}function $(e){try{return btoa(unescape(encodeURIComponent(e)))}catch(t){return console.warn("Failed to base64 encode stats payload:",t),""}}function ee(){const e="/__cowcatwaf/challenge/fp";if(window.__cowcat_meta__&&typeof window.__cowcat_meta__.send=="function")return window.__cowcat_meta__.send(e);if(window.__challenge_fp__){const t=$(JSON.stringify(window.__challenge_fp__));return t?fetch(e,{method:"POST",body:t,keepalive:!0}):Promise.resolve()}return Promise.resolve()}function te(e){const t=Promise.resolve().then(ee).catch(function(n){console.warn("Failed to send challenge stats:",n)}),r=new Promise(function(n){setTimeout(n,e)});return Promise.race([t,r])}let M=null,S=null,A=null;function re(e){M=Date.now(),m(10,"\u8BA1\u7B97\u4E2D..."),S=setInterval(function(){if(M){const t=Date.now()-M,r=Z(c.totalHashes,e),n=Math.min(95,Math.max(10,r));m(n,"Working... (elapsed "+Math.round(t/1e3)+"s)")}},100)}function k(){S&&(clearInterval(S),S=null),M=null}async function ne(e){const t=Q(3,1),r=X(e),n=H(e.worker_type),l=5e7,s=Number.isFinite(Number(e.report_as))?Number(e.report_as):Math.max(1,e.bits/4);re(s);const a=[];let d=!1,i=0;const u=[];c.totalHashes=0,c.hashRate=0,B(0,0);let g=Date.now(),p=0;const b=setInterval(function(){const w=Date.now(),E=(w-g)/1e3,W=c.totalHashes-p;if(E>0){const y=Math.round(W/E);B(y,c.totalHashes),g=w,p=c.totalHashes}},1e3),R=new Promise(function(w,E){const W=Date.now();for(let y=0;y<t;y++){let v;try{v=new Worker("/__cowcatwaf/assets/catpaw.worker.min.js?v="+W)}catch(h){const f={workerId:y,phase:"worker_creation",error:h.message||String(h),errorType:h.name||"WorkerCreationError",errorStack:h.stack||"",browserInfo:{hasWorker:typeof Worker<"u",userAgent:navigator.userAgent}};if(u.push(f),i++,i===t){d=!0,k(),clearInterval(b);const x=new Error("\u6240\u6709\u5DE5\u4F5C\u7EBF\u7A0B\u521B\u5EFA\u5931\u8D25");x.details=u,E(x)}continue}a.push(v),v.onmessage=function(h){if(d)return;const f=h.data||{};if(f.type==="progress"&&typeof f.hashes=="number"){c.totalHashes+=f.hashes;return}if(f&&f.error){if(u.push({workerId:y,phase:"worker_execution",error:f.error,errorType:f.errorType||"WorkerError",errorStack:f.errorStack||"",workerInfo:f.workerInfo,browserInfo:f.browserInfo}),i++,i===t){d=!0,k(),clearInterval(b);const x=new Error(f.error||"\u5DE5\u4F5C\u7EBF\u7A0B\u6267\u884C\u9519\u8BEF");x.details=u,E(x)}return}f&&typeof f.nonce=="string"&&(d=!0,k(),clearInterval(b),m(95,"\u8BA1\u7B97\u5B8C\u6210"),w(f.nonce))},v.onerror=function(h){if(!d&&(u.push({workerId:y,phase:"worker_onerror",error:h.message||"\u5DE5\u4F5C\u7EBF\u7A0B\u9519\u8BEF",errorType:"WorkerError",filename:h.filename||"",lineno:h.lineno||0,colno:h.colno||0}),i++,i===t)){d=!0,k(),clearInterval(b);const f=new Error("\u5DE5\u4F5C\u7EBF\u7A0B\u9519\u8BEF");f.details=u,E(f)}},v.postMessage({prefix:r,bits:e.bits,start:y,step:t,max_iters:l,worker_type:n})}});try{return await R}finally{for(const w of a)w.terminate();clearInterval(b)}}async function oe(e,t,r,n){m(99,"\u6B63\u5728\u9A8C\u8BC1\u89E3\u51B3\u65B9\u6848..."),I("\u6B63\u5728\u9A8C\u8BC1\u89E3\u51B3\u65B9\u6848...");try{if(typeof crypto<"u"&&crypto.subtle&&typeof crypto.subtle.digest=="function")try{const u="v1|"+n.seed+"|"+n.exp+"|"+n.bits+"|"+n.scope+"|"+n.ua_hash+"|"+t,g=new TextEncoder().encode(u),p=await crypto.subtle.digest("SHA-256",g),R=Array.from(new Uint8Array(p)).map(function(w){return w.toString(16).padStart(2,"0")}).join("");console.log("PoW OK:",R)}catch(u){console.log("PoW hash calculation skipped:",u.message)}else console.log("PoW verification proceeding (crypto.subtle not available for hash logging)");const l=await z(e,t,r);let s="";if(A){const u=Date.now()-A;s="?compute_time="+encodeURIComponent(u)}const a=await fetch("/__cowcatwaf/verify"+s,{method:"POST",headers:{"Content-Type":"application/octet-stream"},body:l}),d=new Uint8Array(await a.arrayBuffer()),i=await G(d);if(!a.ok||i.error)throw new Error(i.error||"\u9A8C\u8BC1\u5931\u8D25");m(100,"\u9A8C\u8BC1\u6210\u529F\uFF01"),o.visualImage1&&(o.visualImage1.style.display="none"),o.visualImage2&&(o.visualImage2.style.display="block"),await te(800),c.manualRedirect?(I("\u9A8C\u8BC1\u6210\u529F\uFF01"),c.pendingRedirectUrl=i.redirect,o.manualRedirectContainer&&(o.manualRedirectContainer.style.display="block")):(I("\u9A8C\u8BC1\u6210\u529F\uFF01\u6B63\u5728\u8DF3\u8F6C..."),setTimeout(function(){window.location.href=i.redirect},350))}catch(l){D(l.message||"\u9A8C\u8BC1\u5931\u8D25\uFF0C\u8BF7\u91CD\u8BD5");let s=99;const a=setInterval(function(){s=Math.max(0,s-.5);const d=s>0?"\u9A8C\u8BC1\u5931\u8D25: "+c.errorMessage+" ("+Math.round(s)+"%)":"\u9A8C\u8BC1\u5931\u8D25";m(s,d),s<=0&&(clearInterval(a),m(0,"\u9A8C\u8BC1\u5931\u8D25"))},50);throw l}}async function L(){try{if(!(window.location.protocol==="https:"||window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1"))throw new Error("\u5B89\u5168\u9519\u8BEF: \u6B64\u9875\u9762\u5FC5\u987B\u5728 HTTPS \u73AF\u5883\u4E0B\u8FD0\u884C\u3002\u5F53\u524D\u534F\u8BAE: "+window.location.protocol);I("\u6B63\u5728\u51C6\u5907\u6311\u6218\u4EFB\u52A1..."),m(0,"\u521D\u59CB\u5316");const t=document.getElementById("pow-task-data");if(!t)throw new Error("\u4EFB\u52A1\u6570\u636E\u672A\u627E\u5230");let r;try{r=JSON.parse(t.textContent)}catch(i){throw new Error("\u4EFB\u52A1\u6570\u636E\u89E3\u6790\u5931\u8D25: "+i.message)}if(!r.task||r.task==="")throw new Error("\u4EFB\u52A1\u6570\u636E\u4E3A\u7A7A");const n=r.redirect||"/";let l;try{l=Uint8Array.from(atob(r.task),function(i){return i.charCodeAt(0)})}catch(i){throw new Error("Base64 \u89E3\u7801\u5931\u8D25: "+i.message)}const s=await j(l),a=Y(l);if(a&&(s.worker_type=H(a)),s.error)throw new Error(s.error||"\u83B7\u53D6\u6311\u6218\u4EFB\u52A1\u5931\u8D25");m(10,"\u4EFB\u52A1\u83B7\u53D6\u6210\u529F"),I("\u8BA1\u7B97\u4E2D..."),A=Date.now();const d=await ne(s);await oe(s.task_id,d,n,s)}catch(e){console.error("Error:",e),e.details?(D(e.message||"\u53D1\u751F\u672A\u77E5\u9519\u8BEF",e.details),console.error("Detailed error info:",e.details)):D(e.message||"\u53D1\u751F\u672A\u77E5\u9519\u8BEF",[{error:e.message||String(e),errorType:e.name||"Error",errorStack:e.stack||"",browserInfo:{userAgent:navigator.userAgent,hasWorker:typeof Worker<"u",hasWebAssembly:typeof WebAssembly<"u",hasTextEncoder:typeof TextEncoder<"u"}}]),k();let t=c.progress;const r=setInterval(function(){t=Math.max(0,t-.5);const n=t>0?"\u9519\u8BEF: "+c.errorMessage+" ("+Math.round(t)+"%)":"\u9A8C\u8BC1\u5931\u8D25";m(t,n),t<=0&&(clearInterval(r),m(0,"\u9A8C\u8BC1\u5931\u8D25"))},50)}}function U(){F(),V()}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",function(){U(),L()}):(U(),L())})();
