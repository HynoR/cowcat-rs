(function(){"use strict";const l={progress:0,status:"\u51C6\u5907\u9A8C\u8BC1\u6311\u6218...",progressText:"\u521D\u59CB\u5316",error:!1,errorMessage:"",errorDetails:null,showErrorDetails:!1,hashRate:0,totalHashes:0,manualRedirect:!1,pendingRedirectUrl:null},n={};function F(){n.statusContainer=document.getElementById("status-container"),n.errorContainer=document.getElementById("error-container"),n.errorMessage=document.getElementById("error-message"),n.errorDetails=document.getElementById("error-details"),n.errorDetailsToggle=document.getElementById("error-details-toggle"),n.errorDetailsContent=document.getElementById("error-details-content"),n.errorDetailsList=document.getElementById("error-details-list"),n.progressPercent=document.getElementById("progress-percent"),n.progressBar=document.getElementById("progress-bar"),n.progressText=document.getElementById("progress-text"),n.hashRateValue=document.getElementById("hash-rate-value"),n.totalHashesValue=document.getElementById("total-hashes-value"),n.hashStatsContainer=document.getElementById("hash-stats"),n.visualImage1=document.getElementById("visual-image-1"),n.visualImage2=document.getElementById("visual-image-2"),n.manualRedirectContainer=document.getElementById("manual-redirect-container"),n.manualRedirectBtn=document.getElementById("manual-redirect-btn")}function m(e,r){const t=Math.min(100,Math.max(0,e));l.progress!==t&&(l.progress=t,n.progressBar&&(n.progressBar.style.width=t+"%"),n.progressPercent&&(n.progressPercent.textContent=Math.round(t)+"%")),r!==void 0&&l.progressText!==r&&(l.progressText=r,n.progressText&&(n.progressText.textContent=r))}function I(e){l.status!==e&&(l.status=e,n.statusContainer&&(n.statusContainer.textContent=e))}function A(e,r=null){l.error=!0,l.errorMessage=e,l.errorDetails=r,l.status="",n.statusContainer&&(n.statusContainer.style.display="none"),n.errorContainer&&(n.errorContainer.style.display="block"),n.errorMessage&&(n.errorMessage.textContent=e),r&&r.length>0&&(N(r),n.errorDetails&&(n.errorDetails.style.display="block"))}function _(e,r){l.hashRate=e,n.hashRateValue&&(n.hashRateValue.textContent=q(e)),n.totalHashesValue&&(n.totalHashesValue.textContent=O(r)),n.hashStatsContainer&&(n.hashStatsContainer.style.display=e>0?"grid":"none")}function P(e){const r=document.createElement("div");return r.textContent=e,r.innerHTML}function N(e){if(!n.errorDetailsList)return;const r=document.getElementById("error-detail-template");if(!r){console.error("Error detail template not found");return}n.errorDetailsList.innerHTML="",e.forEach((t,o)=>{const c=r.content.cloneNode(!0),s=c.querySelector(".error-detail-item"),a=s.querySelector(".error-detail-label");if(a){let i="\u9519\u8BEF #"+(o+1);t.workerId!==void 0&&(i+=" (Worker "+t.workerId+")"),a.textContent=i}const d=(i,u,g)=>{const p=s.querySelector(i);p&&g!==void 0&&g!==""?(p.innerHTML="<strong>"+u+":</strong> "+P(String(g)),p.style.display="block"):p&&(p.style.display="none")};if(d('[data-field="phase"]',"\u9636\u6BB5",t.phase),d('[data-field="error"]',"\u9519\u8BEF",t.error),d('[data-field="errorType"]',"\u7C7B\u578B",t.errorType),d('[data-field="filename"]',"\u6587\u4EF6",t.filename?t.filename+":"+t.lineno+":"+t.colno:void 0),d('[data-field="errorStack"]',"\u5806\u6808",t.errorStack),t.workerInfo){const i=s.querySelector('[data-field="workerInfo"]');if(i){const u=t.workerInfo;i.innerHTML="<strong>Worker \u73AF\u5883:</strong><br>- TextEncoder: "+(u.hasTextEncoder?"\u2713":"\u2717")+"<br>- WebAssembly: "+(u.hasWebAssembly?"\u2713":"\u2717")+"<br>- instantiateStreaming: "+(u.hasWebAssemblyInstantiateStreaming?"\u2713":"\u2717")+"<br>- UserAgent: "+P(u.userAgent),i.style.display="block"}}if(t.browserInfo){const i=s.querySelector('[data-field="browserInfo"]');if(i){const u=t.browserInfo;i.innerHTML="<strong>\u6D4F\u89C8\u5668\u73AF\u5883:</strong><br>- Worker: "+(u.hasWorker?"\u2713":"\u2717")+"<br>- WebAssembly: "+(u.hasWebAssembly?"\u2713":"\u2717")+"<br>- TextEncoder: "+(u.hasTextEncoder?"\u2713":"\u2717")+"<br>- UserAgent: "+P(u.userAgent),i.style.display="block"}}n.errorDetailsList.appendChild(c)})}function V(){n.errorDetailsToggle&&n.errorDetailsToggle.addEventListener("click",function(){l.showErrorDetails=!l.showErrorDetails,n.errorDetailsToggle.textContent=l.showErrorDetails?"\u9690\u85CF\u9519\u8BEF\u8BE6\u60C5":"\u663E\u793A\u9519\u8BEF\u8BE6\u60C5",n.errorDetailsContent&&(n.errorDetailsContent.style.display=l.showErrorDetails?"block":"none")}),n.visualImage1&&n.visualImage1.addEventListener("click",function(){l.manualRedirect=!0,console.log("Manual redirect mode enabled")}),n.visualImage2&&n.visualImage2.addEventListener("click",function(){l.manualRedirect=!0,console.log("Manual redirect mode enabled")}),n.manualRedirectBtn&&n.manualRedirectBtn.addEventListener("click",function(){l.pendingRedirectUrl&&(window.location.href=l.pendingRedirectUrl)})}function q(e){return e>=1e6?(e/1e6).toFixed(2)+" MH/s":e>=1e3?(e/1e3).toFixed(2)+" KH/s":e+" H/s"}function O(e){return e>=1e9?(e/1e9).toFixed(2)+" B":e>=1e6?(e/1e6).toFixed(2)+" M":e>=1e3?(e/1e3).toFixed(2)+" K":e.toString()}const v=(async()=>{const r=await(await fetch("/__cowcatwaf/assets/catpaw.wasm")).arrayBuffer(),{instance:t}=await WebAssembly.instantiate(r,{});return t.exports})();function J(e,r){return new DataView(e.memory.buffer).getUint32(r,!0)}function K(e,r,t){return new Uint8Array(e.memory.buffer,r,t).slice()}function C(e,r){const t=new TextEncoder().encode(r||"");if(t.length===0)return{ptr:0,len:0};const o=e.alloc(t.length);return o?(new Uint8Array(e.memory.buffer,o,t.length).set(t),{ptr:o,len:t.length}):{ptr:0,len:0}}function M(e,r,t){const o=e.alloc(4);if(!o)throw new Error("Failed to allocate memory for output length");new DataView(e.memory.buffer).setUint32(o,0,!0);const c=r(...t,o),s=J(e,o);let a=new Uint8Array;return c&&s>0&&(a=K(e,c,s),e.dealloc(c,s)),e.dealloc(o,4),a}async function te(e){const r=await v,{ptr:t,len:o}=C(r,e),c=M(r,r.encode_task_request,[t,o]);return t&&o>0&&r.dealloc(t,o),c}async function z(e,r,t){const o=await v,c=C(o,e),s=C(o,r),a=C(o,t),d=M(o,o.encode_verify_request,[c.ptr,c.len,s.ptr,s.len,a.ptr,a.len]);return c.ptr&&c.len>0&&o.dealloc(c.ptr,c.len),s.ptr&&s.len>0&&o.dealloc(s.ptr,s.len),a.ptr&&a.len>0&&o.dealloc(a.ptr,a.len),d}async function j(e){const r=await v;if(!e||e.length===0)throw new Error("Empty frame bytes");const t=r.alloc(e.length);if(!t)throw new Error("Failed to allocate memory for frame");new Uint8Array(r.memory.buffer,t,e.length).set(e);const o=M(r,r.decode_task_response,[t,e.length]);return r.dealloc(t,e.length),JSON.parse(new TextDecoder().decode(o))}async function G(e){const r=await v;if(!e||e.length===0)throw new Error("Empty frame bytes");const t=r.alloc(e.length);if(!t)throw new Error("Failed to allocate memory for frame");new Uint8Array(r.memory.buffer,t,e.length).set(e);const o=M(r,r.decode_verify_response,[t,e.length]);return r.dealloc(t,e.length),JSON.parse(new TextDecoder().decode(o))}function Q(e=3,r=1){const t=Math.floor(navigator.hardwareConcurrency||1);return Math.min(e,Math.max(1,t-r))}function X(e){return"v1|"+e.seed+"|"+e.exp+"|"+e.bits+"|"+e.scope+"|"+e.ua_hash+"|"}function H(e){return String(e||"").trim().toLowerCase()==="native"?"native":"wasm"}function Y(e){if(!e||e.length<8)return"";const r=new TextEncoder().encode("cowcatwaflibwafcatcow"),o=new Uint8Array(e).slice();for(let a=0;a<o.length;a++)o[a]^=r[a%r.length];if(o[0]!==67||o[1]!==87||o[2]!==1||o[3]!==2||(o[4]<<24|o[5]<<16|o[6]<<8|o[7])>>>0!==o.length-8)return"";const s=o.subarray(8);for(let a=0;a+3<=s.length;){const d=s[a],i=s[a+1]<<8|s[a+2];if(a+=3,a+i>s.length)return"";if(d===11)return new TextDecoder().decode(s.subarray(a,a+i));a+=i}return""}function Z(e,r){const t=Math.max(0,Math.trunc(Number(e)||0)),o=Number(r);if(!Number.isFinite(o)||o<=0)return 0;const c=Math.pow(16,-o),s=Math.pow(1-c,t),a=(1-Math.pow(s,2))*100;return Number.isFinite(a)?Math.max(0,Math.min(100,a)):0}let D=null,S=null,R=null;function $(e){D=Date.now(),m(10,"\u8BA1\u7B97\u4E2D..."),S=setInterval(function(){if(D){const r=Date.now()-D,t=Z(l.totalHashes,e),o=Math.min(95,Math.max(10,t));m(o,"Working... (elapsed "+Math.round(r/1e3)+"s)")}},100)}function k(){S&&(clearInterval(S),S=null),D=null}async function ee(e){const r=Q(3,1),t=X(e),o=H(e.worker_type),c=5e7,s=Number.isFinite(Number(e.report_as))?Number(e.report_as):Math.max(1,e.bits/4);$(s);const a=[];let d=!1,i=0;const u=[];l.totalHashes=0,l.hashRate=0,_(0,0);let g=Date.now(),p=0;const b=setInterval(function(){const w=Date.now(),E=(w-g)/1e3,B=l.totalHashes-p;if(E>0){const y=Math.round(B/E);_(y,l.totalHashes),g=w,p=l.totalHashes}},1e3),W=new Promise(function(w,E){const B=Date.now();for(let y=0;y<r;y++){let x;try{x=new Worker("/__cowcatwaf/assets/catpaw.worker.min.js?v="+B)}catch(h){const f={workerId:y,phase:"worker_creation",error:h.message||String(h),errorType:h.name||"WorkerCreationError",errorStack:h.stack||"",browserInfo:{hasWorker:typeof Worker<"u",userAgent:navigator.userAgent}};if(u.push(f),i++,i===r){d=!0,k(),clearInterval(b);const T=new Error("\u6240\u6709\u5DE5\u4F5C\u7EBF\u7A0B\u521B\u5EFA\u5931\u8D25");T.details=u,E(T)}continue}a.push(x),x.onmessage=function(h){if(d)return;const f=h.data||{};if(f.type==="progress"&&typeof f.hashes=="number"){l.totalHashes+=f.hashes;return}if(f&&f.error){if(u.push({workerId:y,phase:"worker_execution",error:f.error,errorType:f.errorType||"WorkerError",errorStack:f.errorStack||"",workerInfo:f.workerInfo,browserInfo:f.browserInfo}),i++,i===r){d=!0,k(),clearInterval(b);const T=new Error(f.error||"\u5DE5\u4F5C\u7EBF\u7A0B\u6267\u884C\u9519\u8BEF");T.details=u,E(T)}return}f&&typeof f.nonce=="string"&&(d=!0,k(),clearInterval(b),m(95,"\u8BA1\u7B97\u5B8C\u6210"),w(f.nonce))},x.onerror=function(h){if(!d&&(u.push({workerId:y,phase:"worker_onerror",error:h.message||"\u5DE5\u4F5C\u7EBF\u7A0B\u9519\u8BEF",errorType:"WorkerError",filename:h.filename||"",lineno:h.lineno||0,colno:h.colno||0}),i++,i===r)){d=!0,k(),clearInterval(b);const f=new Error("\u5DE5\u4F5C\u7EBF\u7A0B\u9519\u8BEF");f.details=u,E(f)}},x.postMessage({prefix:t,bits:e.bits,start:y,step:r,max_iters:c,worker_type:o})}});try{return await W}finally{for(const w of a)w.terminate();clearInterval(b)}}async function re(e,r,t,o){m(99,"\u6B63\u5728\u9A8C\u8BC1\u89E3\u51B3\u65B9\u6848..."),I("\u6B63\u5728\u9A8C\u8BC1\u89E3\u51B3\u65B9\u6848...");try{if(typeof crypto<"u"&&crypto.subtle&&typeof crypto.subtle.digest=="function")try{const u="v1|"+o.seed+"|"+o.exp+"|"+o.bits+"|"+o.scope+"|"+o.ua_hash+"|"+r,g=new TextEncoder().encode(u),p=await crypto.subtle.digest("SHA-256",g),W=Array.from(new Uint8Array(p)).map(function(w){return w.toString(16).padStart(2,"0")}).join("");console.log("PoW OK:",W)}catch(u){console.log("PoW hash calculation skipped:",u.message)}else console.log("PoW verification proceeding (crypto.subtle not available for hash logging)");const c=await z(e,r,t);let s="";if(R){const u=Date.now()-R;s="?compute_time="+encodeURIComponent(u)}const a=await fetch("/__cowcatwaf/verify"+s,{method:"POST",headers:{"Content-Type":"application/octet-stream"},body:c}),d=new Uint8Array(await a.arrayBuffer()),i=await G(d);if(!a.ok||i.error)throw new Error(i.error||"\u9A8C\u8BC1\u5931\u8D25");m(100,"\u9A8C\u8BC1\u6210\u529F\uFF01"),n.visualImage1&&(n.visualImage1.style.display="none"),n.visualImage2&&(n.visualImage2.style.display="block"),l.manualRedirect?(I("\u9A8C\u8BC1\u6210\u529F\uFF01"),l.pendingRedirectUrl=i.redirect,n.manualRedirectContainer&&(n.manualRedirectContainer.style.display="block")):(I("\u9A8C\u8BC1\u6210\u529F\uFF01\u6B63\u5728\u8DF3\u8F6C..."),setTimeout(function(){window.location.href=i.redirect},350))}catch(c){A(c.message||"\u9A8C\u8BC1\u5931\u8D25\uFF0C\u8BF7\u91CD\u8BD5");let s=99;const a=setInterval(function(){s=Math.max(0,s-.5);const d=s>0?"\u9A8C\u8BC1\u5931\u8D25: "+l.errorMessage+" ("+Math.round(s)+"%)":"\u9A8C\u8BC1\u5931\u8D25";m(s,d),s<=0&&(clearInterval(a),m(0,"\u9A8C\u8BC1\u5931\u8D25"))},50);throw c}}async function L(){try{if(!(window.location.protocol==="https:"||window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1"))throw new Error("\u5B89\u5168\u9519\u8BEF: \u6B64\u9875\u9762\u5FC5\u987B\u5728 HTTPS \u73AF\u5883\u4E0B\u8FD0\u884C\u3002\u5F53\u524D\u534F\u8BAE: "+window.location.protocol);I("\u6B63\u5728\u51C6\u5907\u6311\u6218\u4EFB\u52A1..."),m(0,"\u521D\u59CB\u5316");const r=document.getElementById("pow-task-data");if(!r)throw new Error("\u4EFB\u52A1\u6570\u636E\u672A\u627E\u5230");let t;try{t=JSON.parse(r.textContent)}catch(i){throw new Error("\u4EFB\u52A1\u6570\u636E\u89E3\u6790\u5931\u8D25: "+i.message)}if(!t.task||t.task==="")throw new Error("\u4EFB\u52A1\u6570\u636E\u4E3A\u7A7A");const o=t.redirect||"/";let c;try{c=Uint8Array.from(atob(t.task),function(i){return i.charCodeAt(0)})}catch(i){throw new Error("Base64 \u89E3\u7801\u5931\u8D25: "+i.message)}const s=await j(c),a=Y(c);if(a&&(s.worker_type=H(a)),s.error)throw new Error(s.error||"\u83B7\u53D6\u6311\u6218\u4EFB\u52A1\u5931\u8D25");m(10,"\u4EFB\u52A1\u83B7\u53D6\u6210\u529F"),I("\u8BA1\u7B97\u4E2D..."),R=Date.now();const d=await ee(s);await re(s.task_id,d,o,s)}catch(e){console.error("Error:",e),e.details?(A(e.message||"\u53D1\u751F\u672A\u77E5\u9519\u8BEF",e.details),console.error("Detailed error info:",e.details)):A(e.message||"\u53D1\u751F\u672A\u77E5\u9519\u8BEF",[{error:e.message||String(e),errorType:e.name||"Error",errorStack:e.stack||"",browserInfo:{userAgent:navigator.userAgent,hasWorker:typeof Worker<"u",hasWebAssembly:typeof WebAssembly<"u",hasTextEncoder:typeof TextEncoder<"u"}}]),k();let r=l.progress;const t=setInterval(function(){r=Math.max(0,r-.5);const o=r>0?"\u9519\u8BEF: "+l.errorMessage+" ("+Math.round(r)+"%)":"\u9A8C\u8BC1\u5931\u8D25";m(r,o),r<=0&&(clearInterval(t),m(0,"\u9A8C\u8BC1\u5931\u8D25"))},50)}}function U(){F(),V()}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",function(){U(),L()}):(U(),L())})();
