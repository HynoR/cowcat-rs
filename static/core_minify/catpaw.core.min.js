(function(){"use strict";const y=(async()=>{const t=await(await fetch("/__cowcatwaf/assets/catpaw.wasm")).arrayBuffer(),{instance:r}=await WebAssembly.instantiate(t,{});return r.exports})();function V(e,t){return new DataView(e.memory.buffer).getUint32(t,!0)}function N(e,t,r){return new Uint8Array(e.memory.buffer,t,r).slice()}function m(e,t){const r=new TextEncoder().encode(t||"");if(r.length===0)return{ptr:0,len:0};const n=e.alloc(r.length);return n?(new Uint8Array(e.memory.buffer,n,r.length).set(r),{ptr:n,len:r.length}):{ptr:0,len:0}}function g(e,t,r){const n=e.alloc(4);if(!n)throw new Error("Failed to allocate memory for output length");new DataView(e.memory.buffer).setUint32(n,0,!0);const c=t(...r,n),a=V(e,n);let o=new Uint8Array;return c&&a>0&&(o=N(e,c,a),e.dealloc(c,a)),e.dealloc(n,4),o}async function O(e,t,r){const n=await y,c=m(n,e),a=m(n,t),o=m(n,r),i=g(n,n.encode_verify_request,[c.ptr,c.len,a.ptr,a.len,o.ptr,o.len]);return c.ptr&&c.len>0&&n.dealloc(c.ptr,c.len),a.ptr&&a.len>0&&n.dealloc(a.ptr,a.len),o.ptr&&o.len>0&&n.dealloc(o.ptr,o.len),i}async function S(e){const t=await y;if(!e||e.length===0)throw new Error("Empty frame bytes");const r=t.alloc(e.length);if(!r)throw new Error("Failed to allocate memory for frame");new Uint8Array(t.memory.buffer,r,e.length).set(e);const n=g(t,t.decode_task_response,[r,e.length]);return t.dealloc(r,e.length),JSON.parse(new TextDecoder().decode(n))}async function R(e){const t=await y;if(!e||e.length===0)throw new Error("Empty frame bytes");const r=t.alloc(e.length);if(!r)throw new Error("Failed to allocate memory for frame");new Uint8Array(t.memory.buffer,r,e.length).set(e);const n=g(t,t.decode_verify_response,[r,e.length]);return t.dealloc(r,e.length),JSON.parse(new TextDecoder().decode(n))}function F(e=3,t=1){const r=Math.floor(navigator.hardwareConcurrency||1);return Math.min(e,Math.max(1,r-t))}function J(e){return"v1|"+e.seed+"|"+e.exp+"|"+e.bits+"|"+e.scope+"|"+e.ua_hash+"|"}function v(e){return String(e||"").trim().toLowerCase()==="native"?"native":"wasm"}function q(e){if(!e||e.length<8)return"";const t=new TextEncoder().encode("cowcatwaflibwafcatcow"),n=new Uint8Array(e).slice();for(let o=0;o<n.length;o++)n[o]^=t[o%t.length];if(n[0]!==67||n[1]!==87||n[2]!==1||n[3]!==2||(n[4]<<24|n[5]<<16|n[6]<<8|n[7])>>>0!==n.length-8)return"";const a=n.subarray(8);for(let o=0;o+3<=a.length;){const i=a[o],w=a[o+1]<<8|a[o+2];if(o+=3,o+w>a.length)return"";if(i===11)return new TextDecoder().decode(a.subarray(o,o+w));o+=w}return""}window.__cowcat__={state:"idle",totalHashes:0,hashRate:0,task:null,redirect:null,error:null};const Y=1e3,z=600,A=.3,B=.85;let h=null,p=null,E=0,k=0,d=0;function M(e,t){document.dispatchEvent(new CustomEvent("cowcat:"+e,{detail:t}))}function D(){return{state:window.__cowcat__.state,totalHashes:window.__cowcat__.totalHashes,hashRate:window.__cowcat__.hashRate,task:window.__cowcat__.task,redirect:window.__cowcat__.redirect,error:window.__cowcat__.error}}function G(){M("state",D())}function L(){M("metrics",D())}function l(e,t,r,n,c){e!==void 0&&(window.__cowcat__.state=e,e!=="solving"&&(window.__cowcat__.hashRate=0)),t!==void 0&&(window.__cowcat__.totalHashes=t),t!==void 0&&t<0&&(window.__cowcat__.totalHashes=0),r!==void 0&&(window.__cowcat__.task=r),n!==void 0&&(window.__cowcat__.redirect=n),c!==void 0&&(window.__cowcat__.error=c),G()}function K(e){window.__cowcat__.totalHashes=e<0?0:e}function I(){E=window.__cowcat__.totalHashes||0,k=Date.now(),d=0,window.__cowcat__.hashRate=0}function Q(){const e=Date.now(),t=window.__cowcat__.totalHashes||0,r=t-E,n=(e-k)/1e3;let c=0;n>0&&r>0&&(c=r/n),c>0?d=d>0?d*(1-A)+c*A:c:d>0&&(d*=B,d<1&&(d=0)),E=t,k=e,window.__cowcat__.hashRate=Math.round(d),L()}function X(){T(!1),h=setTimeout(function(){I(),p=setInterval(Q,z)},Y)}function T(e){h&&(clearTimeout(h),h=null),p&&(clearInterval(p),p=null),e&&(I(),L())}async function U(e){const t=F(3,1),r=J(e),n=v(e.worker_type),c=5e7;l("solving",0,void 0,void 0,null),X();const a=[];let o=!1,i=0;const w=[];let H=0;const Z=new Promise(function(C,x){const $=Date.now();for(let u=0;u<t;u++){let _;try{_=new Worker("/__cowcatwaf/assets/catpaw.worker.js?v="+$)}catch(f){if(w.push({workerId:u,phase:"worker_creation",error:f.message||String(f)}),i++,i===t){o=!0;const s=new Error("\u6240\u6709\u5DE5\u4F5C\u7EBF\u7A0B\u521B\u5EFA\u5931\u8D25");s.details=w,x(s)}continue}a.push(_),_.onmessage=function(f){if(o)return;const s=f.data||{};if(s.type==="progress"&&typeof s.hashes=="number"){H+=s.hashes,K(H);return}if(s&&s.error){if(w.push({workerId:u,phase:"worker_execution",error:s.error}),i++,i===t){o=!0;const W=new Error(s.error||"\u5DE5\u4F5C\u7EBF\u7A0B\u6267\u884C\u9519\u8BEF");W.details=w,x(W)}return}s&&typeof s.nonce=="string"&&(o=!0,C(s.nonce))},_.onerror=function(f){if(!o&&(w.push({workerId:u,phase:"worker_onerror",error:f.message||"\u5DE5\u4F5C\u7EBF\u7A0B\u9519\u8BEF"}),i++,i===t)){o=!0;const s=new Error("\u5DE5\u4F5C\u7EBF\u7A0B\u9519\u8BEF");s.details=w,x(s)}},_.postMessage({prefix:r,bits:e.bits,start:u,step:t,max_iters:c,worker_type:n})}});try{return await Z}finally{for(const C of a)C.terminate()}}async function P(e,t,r,n){T(!0),l("verifying",void 0,void 0,void 0,null);try{const c=await O(e,t,r),a=await fetch("/__cowcatwaf/verify",{method:"POST",headers:{"Content-Type":"application/octet-stream"},body:c}),o=new Uint8Array(await a.arrayBuffer()),i=await R(o);if(!a.ok||i.error)throw new Error(i.error||"\u9A8C\u8BC1\u5931\u8D25");l("success",void 0,void 0,i.redirect,null),window.__cowcat_meta__&&typeof window.__cowcat_meta__.send=="function"&&window.__cowcat_meta__.send("/__cowcatwaf/challenge/fp").catch(function(){}),setTimeout(function(){window.location.href=i.redirect},350)}catch(c){throw l("error",void 0,void 0,void 0,c.message||"\u9A8C\u8BC1\u5931\u8D25"),c}}async function b(){const e=document.getElementById("pow-task-data");if(e)try{if(!(window.location.protocol==="https:"||window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1"))throw new Error("\u5B89\u5168\u9519\u8BEF: \u6B64\u9875\u9762\u5FC5\u987B\u5728 HTTPS \u73AF\u5883\u4E0B\u8FD0\u884C");let r;try{r=JSON.parse(e.textContent)}catch{throw new Error("\u4EFB\u52A1\u6570\u636E\u89E3\u6790\u5931\u8D25")}if(!r.task||r.task==="")throw new Error("\u4EFB\u52A1\u6570\u636E\u4E3A\u7A7A");const n=r.redirect||"/";let c;try{c=Uint8Array.from(atob(r.task),function(w){return w.charCodeAt(0)})}catch{throw new Error("Base64 \u89E3\u7801\u5931\u8D25")}const a=await S(c),o=q(c);if(o&&(a.worker_type=v(o)),a.error)throw new Error(a.error||"\u83B7\u53D6\u6311\u6218\u4EFB\u52A1\u5931\u8D25");l("idle",0,a,n,null);const i=await U(a);await P(a.task_id,i,n,a)}catch(t){console.error("CowcatCore Error:",t),T(!0),l("error",void 0,void 0,void 0,t.message||"\u53D1\u751F\u672A\u77E5\u9519\u8BEF")}}window.CowcatCore={decodeTaskResponse:S,decodeVerifyResponse:R,solveChallenge:U,verifyAndRedirect:P,run:b},document.readyState==="loading"?document.addEventListener("DOMContentLoaded",b):b()})();
